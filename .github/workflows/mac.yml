name: Build and Distribute iOS IPA

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build IPA and Upload to TestFlight
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Xcode version
        run: /usr/bin/xcodebuild -version

      # üê¶ Install Flutter
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      # üîê Create and unlock keychain
      - name: Create keychain
        run: |
          security create-keychain -p "${{ secrets.IOS_GITHUB_KEYCHAIN_PASSWORD }}" ios-build.keychain
          security unlock-keychain -p "${{ secrets.IOS_GITHUB_KEYCHAIN_PASSWORD }}" ios-build.keychain
          security set-keychain-settings -t 3600 -l ios-build.keychain
          security list-keychains -d user -s ios-build.keychain $(security list-keychains -d user | tr -d '"')
          security default-keychain -s ios-build.keychain

      # üîë Install Development & Distribution Certificates and Provisioning Profiles
      - name: Install certificates and provisioning profiles
        run: |
          set -e
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          # Development certificate
          DEV_CERT=$RUNNER_TEMP/dev.p12
          echo "${{ secrets.IOS_DEV_CERTIFICATE_BASE64 }}" | base64 --decode > $DEV_CERT
          security import $DEV_CERT -k ios-build.keychain -P "${{ secrets.IOS_BUILD_CERTIFICATE_PASSWORD }}" -A -T /usr/bin/codesign

          # Development provisioning profile
          DEV_PP=$RUNNER_TEMP/dev_profile.mobileprovision
          echo "${{ secrets.IOS_DEV_MOBILE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > $DEV_PP
          cp $DEV_PP ~/Library/MobileDevice/Provisioning\ Profiles/

          # Distribution certificate
          DIST_CERT=$RUNNER_TEMP/dist.p12
          echo "${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}" | base64 --decode > $DIST_CERT
          security import $DIST_CERT -k ios-build.keychain -P "${{ secrets.IOS_BUILD_CERTIFICATE_PASSWORD }}" -A -T /usr/bin/codesign

          # Distribution provisioning profile
          DIST_PP=$RUNNER_TEMP/dist_profile.mobileprovision
          echo "${{ secrets.IOS_MOBILE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > $DIST_PP
          cp $DIST_PP ~/Library/MobileDevice/Provisioning\ Profiles/

          echo "Installed signing identities:"
          security find-identity -v

      # üèó Patch pbxproj for correct development team and bundle ID
      - name: Patch Xcode project for CI
        run: |
          PBXPROJ="ios/Runner.xcodeproj/project.pbxproj"
          DEV_TEAM="AVGT6H69KV"
          BUNDLE_ID="com.viper10554.scouting"

          # Manual signing
          perl -pi -e 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' "$PBXPROJ"

          # Insert DEVELOPMENT_TEAM if missing
          perl -0777 -pi -e "s/(buildSettings = \{)/\$1\n\t\tDEVELOPMENT_TEAM = $DEV_TEAM;/" "$PBXPROJ"

          # Set PRODUCT_BUNDLE_IDENTIFIER
          perl -pi -e "s/PRODUCT_BUNDLE_IDENTIFIER = [^;]+;/PRODUCT_BUNDLE_IDENTIFIER = $BUNDLE_ID;/g" "$PBXPROJ"

          echo "pbxproj patched: Manual signing, development team, bundle ID applied"

      # üì¶ Flutter build without codesign
      - name: Flutter build IPA
        run: flutter build ipa --release --export-options-plist=ios/GithubActionsExportOptions.plist --no-codesign

      # üèó Archive and export IPA using xcodebuild + ExportOptions.plist
      - name: Archive and export IPA
        run: |
          ARCHIVE_PATH=$PWD/build/ios/archive
          IPA_OUTPUT_PATH=$PWD/build/ios/ipa
          mkdir -p $ARCHIVE_PATH $IPA_OUTPUT_PATH

          xcodebuild archive \
            -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath $ARCHIVE_PATH/Runner.xcarchive

          xcodebuild -exportArchive \
            -archivePath $ARCHIVE_PATH/Runner.xcarchive \
            -exportOptionsPlist ios/GithubActionsExportOptions.plist \
            -exportPath $IPA_OUTPUT_PATH

      # üì¶ Upload IPA artifact
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-ipa
          path: build/ios/ipa/Runner.ipa

      # üöÄ Upload to TestFlight
      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v3
        with:
          app-path: build/ios/ipa/Runner.ipa
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}